name: Test mpak Announce

on:
  workflow_dispatch:
    inputs:
      mpak_api_url:
        description: 'mpak API URL (e.g., https://xxxx.ngrok.app for local testing)'
        required: true
        default: 'https://api.mpak.dev'
      version:
        description: 'Version to announce (must match an existing release, e.g., 0.1.0)'
        required: true
        default: '0.1.0'

permissions:
  id-token: write
  contents: read

jobs:
  announce:
    runs-on: ubuntu-latest
    steps:
      # Checkout main to get the updated manifest (tags may have old package names)
      - uses: actions/checkout@v4

      - name: Update manifest version
        run: |
          jq --arg v "${{ inputs.version }}" '.version = $v' manifest.json > manifest.tmp.json
          mv manifest.tmp.json manifest.json

      - name: Get OIDC Token
        id: oidc
        run: |
          TOKEN=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=https://mpak.dev" | jq -r '.value')

          if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
            echo "Failed to get OIDC token"
            exit 1
          fi

          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Announce to mpak
        env:
          OIDC_TOKEN: ${{ steps.oidc.outputs.token }}
          MPAK_API: ${{ inputs.mpak_api_url }}
        run: |
          PKG_NAME=$(jq -r '.name' manifest.json)
          RELEASE_TAG="v${{ inputs.version }}"
          echo "Announcing $PKG_NAME v${{ inputs.version }} (release: $RELEASE_TAG) to $MPAK_API"

          # Build JSON payload using jq to avoid escaping issues
          # The announce endpoint will discover all .mcpb artifacts from the release
          PAYLOAD=$(jq -n \
            --arg name "$PKG_NAME" \
            --arg version "${{ inputs.version }}" \
            --slurpfile manifest manifest.json \
            --arg release_tag "$RELEASE_TAG" \
            '{
              name: $name,
              version: $version,
              manifest: $manifest[0],
              release_tag: $release_tag
            }')

          echo "Payload:"
          echo "$PAYLOAD" | jq .

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$MPAK_API/v1/bundles/announce" \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "Response:"
          echo "$BODY" | jq . || echo "$BODY"

          if [ "$HTTP_CODE" -ge 400 ]; then
            exit 1
          fi
