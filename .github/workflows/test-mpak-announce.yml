name: Test mpak Announce

on:
  workflow_dispatch:
    inputs:
      mpak_api_url:
        description: 'mpak API URL (e.g., https://xxxx.ngrok.app for local testing)'
        required: true
        default: 'https://api.mpak.dev'
      version:
        description: 'Version to announce (must match an existing release, e.g., 0.1.0)'
        required: true
        default: '0.1.0'
      platform:
        description: 'Platform (linux-amd64 or linux-arm64)'
        required: true
        default: 'linux-amd64'
        type: choice
        options:
          - linux-amd64
          - linux-arm64

permissions:
  id-token: write
  contents: read

jobs:
  announce:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: v${{ inputs.version }}

      - name: Get Release Asset Info
        id: asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get asset info from the release
          ASSET_NAME="mcp-echo-v${{ inputs.version }}-${{ inputs.platform }}.mcpb"
          echo "Looking for asset: $ASSET_NAME"

          ASSET_INFO=$(gh release view "v${{ inputs.version }}" --json assets \
            | jq -r --arg name "$ASSET_NAME" '.assets[] | select(.name == $name)')

          if [ -z "$ASSET_INFO" ]; then
            echo "Asset not found: $ASSET_NAME"
            gh release view "v${{ inputs.version }}" --json assets | jq '.assets[].name'
            exit 1
          fi

          URL=$(echo "$ASSET_INFO" | jq -r '.url')
          SIZE=$(echo "$ASSET_INFO" | jq -r '.size')
          # GitHub includes digest in format "sha256:xxxx"
          SHA256=$(echo "$ASSET_INFO" | jq -r '.digest' | sed 's/sha256://')

          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

          echo "Asset URL: $URL"
          echo "Asset size: $SIZE"
          echo "Asset SHA256: $SHA256"

      - name: Get OIDC Token
        id: oidc
        run: |
          TOKEN=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=https://mpak.dev" | jq -r '.value')

          if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
            echo "Failed to get OIDC token"
            exit 1
          fi

          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Read manifest
        id: manifest
        run: |
          MANIFEST=$(cat manifest.json)
          echo "manifest<<EOF" >> $GITHUB_OUTPUT
          echo "$MANIFEST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Manifest:"
          cat manifest.json

      - name: Announce to mpak
        env:
          OIDC_TOKEN: ${{ steps.oidc.outputs.token }}
          MPAK_API: ${{ inputs.mpak_api_url }}
        run: |
          PKG_NAME=$(jq -r '.name' manifest.json)
          echo "Announcing $PKG_NAME v${{ inputs.version }} to $MPAK_API"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$MPAK_API/v1/bundles/announce" \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"name\": \"$PKG_NAME\",
              \"version\": \"${{ inputs.version }}\",
              \"manifest\": ${{ steps.manifest.outputs.manifest }},
              \"artifact\": {
                \"url\": \"${{ steps.asset.outputs.url }}\",
                \"sha256\": \"${{ steps.asset.outputs.sha256 }}\",
                \"size\": ${{ steps.asset.outputs.size }}
              }
            }")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "Response:"
          echo "$BODY" | jq . || echo "$BODY"

          if [ "$HTTP_CODE" -ge 400 ]; then
            exit 1
          fi
